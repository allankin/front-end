<!-- index.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>React Tutorial</title>
    <script src="js/react.min.js"></script>
    <script src="js/react-dom.min.js"></script>
    <script src="js/babel.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/remarkable.min.js"></script>
  </head>
  <body>
    <div id="content"></div>
    <script type="text/babel">
      var SearchBar = React.createClass({
        propTypes:{
          searchText:React.PropTypes.string.isRequired
        },
        searchTextOnChange:function(e){
          var text = this.refs.searchTextInput.value;
          console.log(this.refs.isStockCheckBox.checked);
          var isStocked = this.refs.isStockCheckBox.checked;
          this.props.onUserInput(text,isStocked);
        },
        render: function() {
          return (
            <div>
              <input type="text" ref='searchTextInput' onChange={this.searchTextOnChange} value={this.props.searchText}/><br/>
              <input type="checkbox" ref='isStockCheckBox' onChange={this.searchTextOnChange} checked={this.props.stocked}/> only show in stock
            </div>
          );
        }
      });
      var ProductCategoryRow = React.createClass({
        render: function(){
          return (<tr><td style={{color:'green'}}>{this.props.name}</td><td></td></tr>);
        }
      });
      var ProductRow = React.createClass({
        render: function(){
          return (
            <tr><td>{this.props.product.name}</td><td>{this.props.product.price}</td><td>{this.props.product.stocked?'true':'false'}</td></tr>
          );
        }
      });
      var ProductTable = React.createClass({
        getInitialState: function(){
          console.log('ProductTable  getInitialState');
          return {'data':[]};
        },
        loadData: function(){
          $.ajax({
            url:this.props.url,
            dataType:'json',
            cache:false,
            success:function(data){
              this.setState({data:data});
              console.log("ajax success "+this.state.data);
            }.bind(this),
            error:function(xhr, status, err) {
              console.error(this.props.url, status, err.toString());
            }.bind(this)
          });
        },
        componentDidMount: function(){
          this.loadData();
        },
        render: function(){ 
          console.log("ProductTable render:"+this.props.searchText+",stocked:"+this.props.stocked);
          var searchText = this.props.searchText;
          var isStocked = typeof this.props.stocked == 'undefined'?false:this.props.stocked;
          var currentCategory;
          var rows = [];
          console.log("this.state.data length:"+this.state.data.length);
          this.state.data.forEach(function(product){
            if(searchText){
              if(product.name.indexOf(searchText)==-1){
                return false; 
              }
            }
            console.log("isStocked:"+isStocked+",product.stocked:"+product.stocked);
            if(isStocked != product.stocked){
              return false; 
            }
            if(currentCategory!=product.category){
              currentCategory = product.category;
              rows.push(<ProductCategoryRow name={product.category}/> );
            } 
            rows.push (<ProductRow name={product.name} price={product.price} stocked={product.stocked} product={product}/>);
          });
          console.log("rows length:"+rows.length);
          return (
            <div>
              <table>
                <thead><th>名称</th><th>价格</th><th>isStocked</th></thead>
                {rows}  
                <tr></tr>
                <tr></tr>
              </table>
            </div>
          );
        }
      });

      var SearchContainer = React.createClass({
        getInitialState:function(){
          return {
            searchText:'',
            stocked:false
          };
        },
        handleUserInput:function(searchText,stocked){
            this.setState({
              searchText:searchText,
              stocked:stocked
            });
        },
        render: function(){
          console.log("SearchContainer render");
          return (
            <div>
              <SearchBar onUserInput={this.handleUserInput} searchText={this.state.searchText} stocked={this.state.stocked}/>
              <ProductTable url="products.json" searchText={this.state.searchText} stocked={this.state.stocked}/>
            </div>
          );
        }
      });
      ReactDOM.render(
        <SearchContainer/>,
        document.getElementById('content')
      );
    </script>
  </body>
</html>